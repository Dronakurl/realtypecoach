<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Practice</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Roboto Mono', 'Consolas', monospace;
            max-width: 900px; margin: 40px auto; padding: 20px;
            background: #1a1a1a; color: #e0e0e0;
        }
        .stats {
            display: flex; gap: 20px; margin-bottom: 20px;
            font-size: 18px;
        }
        .stat { background: #2a2a2a; padding: 10px 20px; border-radius: 5px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
        #textDisplay {
            font-size: 20px; line-height: 1.8; margin-bottom: 20px;
            background: #2a2a2a; padding: 20px; border-radius: 5px;
            white-space: pre-wrap; word-break: break-word;
            max-height: 300px; overflow-y: auto; position: relative;
            scroll-behavior: smooth;
        }
        #textDisplay::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0;
            height: 40px;
            background: linear-gradient(to bottom, #2a2a2a 0%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }
        .correct { color: #4CAF50; }
        .incorrect { color: #f44336; text-decoration: underline; }
        .current { background: #FFC107; color: #000; border-radius: 2px; }
        .hardest-word { background: #ff6b3533; border-radius: 3px; }
        .fastest-word { background: #4CAF5033; border-radius: 3px; }
        .digraph { background: #2196F333; border-radius: 2px; }
        #hiddenInput {
            position: absolute; opacity: 0; top: -1000px;
        }
        body { cursor: text; }
        .hidden { display: none; }
        #restart {
            background: #4CAF50; color: white; border: none;
            padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer;
            margin-top: 10px;
        }
        #restart:hover { background: #45a049; }
    </style>
</head>
<body>
    <div class="stats">
        <div class="stat">WPM: <span id="wpm" class="stat-value">0</span></div>
        <div class="stat">Accuracy: <span id="accuracy" class="stat-value">100%</span></div>
        <div class="stat">Time: <span id="time" class="stat-value">0:00</span></div>
    </div>

    <textarea id="hiddenInput" autofocus></textarea>
    <div id="textDisplay"></div>
    <button id="restart">Restart (Tab)</button>

    <script>
        const params = new URLSearchParams(window.location.search);
        const textParam = params.get('text');
        const hardestParam = params.get('hardest');
        const fastestParam = params.get('fastest');
        const digraphsParam = params.get('digraphs');
        const hardestWords = hardestParam ? hardestParam.split(',') : [];
        const fastestWords = fastestParam ? fastestParam.split(',') : [];
        const digraphs = digraphsParam ? digraphsParam.split(',') : [];
        const defaultText = "The quick brown fox jumps over the lazy dog. " +
            "Pack my box with five dozen liquor jugs. " +
            "How vexingly quick daft zebras jump!";

        let targetText = textParam ? decodeURIComponent(textParam) : defaultText;
        let startTime = null;
        let completed = false;

        const display = document.getElementById('textDisplay');
        const input = document.getElementById('hiddenInput');
        const wpmDisplay = document.getElementById('wpm');
        const accuracyDisplay = document.getElementById('accuracy');
        const timeDisplay = document.getElementById('time');
        const restartBtn = document.getElementById('restart');

        function renderText() {
            const typed = input.value;
            let html = '';

            // Build sets for O(1) lookup of words (case-insensitive)
            const hardestSet = new Set(hardestWords.map(w => w.toLowerCase()));
            const fastestSet = new Set(fastestWords.map(w => w.toLowerCase()));
            const digraphSet = new Set(digraphs.map(d => d.toLowerCase()));

            // Helper to check if a character is part of a word (Unicode-aware)
            // Matches any character that's NOT whitespace, punctuation, or symbols
            const isWordChar = (c) => !/[\s\p{P}\p{S}]/u.test(c);

            for (let i = 0; i < targetText.length; i++) {
                // Find the word boundaries around position i (Unicode-aware)
                let start = i;
                while (start > 0 && isWordChar(targetText[start - 1])) start--;
                let end = i;
                while (end < targetText.length && isWordChar(targetText[end])) end++;
                const word = targetText.slice(start, end).toLowerCase();

                // Check if this position is within a fastest or hardest word
                // Fastest takes priority if word appears in both lists
                let inFastestWord = fastestSet.size > 0 && fastestSet.has(word);
                let inHardestWord = !inFastestWord && hardestSet.size > 0 && hardestSet.has(word);

                // Check if this position is part of a highlighted digraph
                let inDigraph = false;
                if (digraphSet.size > 0) {
                    // Check if this position is the first character of a digraph
                    if (i < targetText.length - 1) {
                        const twoChar = targetText.slice(i, i + 2).toLowerCase();
                        if (digraphSet.has(twoChar)) {
                            inDigraph = true;
                        }
                    }
                    // Check if this position is the second character of a digraph
                    if (!inDigraph && i > 0) {
                        const twoChar = targetText.slice(i - 1, i + 1).toLowerCase();
                        if (digraphSet.has(twoChar)) {
                            inDigraph = true;
                        }
                    }
                }

                let className = '';
                let style = '';
                let content = escapeHtml(targetText[i]);

                if (i < typed.length) {
                    if (typed[i] === targetText[i]) {
                        className = 'correct';
                    } else {
                        className = 'incorrect';
                    }
                } else if (i === typed.length) {
                    className = 'current';
                }

                if (inFastestWord && className !== 'current') {
                    className = className ? `${className} fastest-word` : 'fastest-word';
                } else if (inHardestWord && className !== 'current') {
                    className = className ? `${className} hardest-word` : 'hardest-word';
                }

                // Add digraph highlighting (can combine with word highlighting)
                if (inDigraph && className !== 'current') {
                    className = className ? `${className} digraph` : 'digraph';
                }

                if (className) {
                    html += `<span class="${className}">${content}</span>`;
                } else {
                    html += content;
                }
            }
            display.innerHTML = html;
            scrollToCurrent();
        }

        function scrollToCurrent() {
            const currentChar = display.querySelector('.current');
            if (currentChar) {
                const containerHeight = display.clientHeight;
                const charTop = currentChar.offsetTop;
                const charHeight = currentChar.offsetHeight;
                const lineHeight = 36; // 20px font * 1.8 line-height

                // Keep current character in the upper middle of the visible area
                const targetScroll = charTop - containerHeight / 3;

                // Only scroll if the current character is below the visible area
                if (targetScroll > display.scrollTop) {
                    display.scrollTop = targetScroll;
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function calculateStats() {
            if (!startTime) return;

            const typed = input.value;
            const correct = typed.split('').filter((c, i) => c === targetText[i]).length;
            const accuracy = typed.length > 0 ? Math.round((correct / typed.length) * 100) : 100;

            const elapsed = (Date.now() - startTime) / 1000 / 60; // minutes
            const words = typed.trim().split(/\s+/).length;
            const wpm = elapsed > 0 ? Math.round(words / elapsed) : 0;

            wpmDisplay.textContent = wpm;
            accuracyDisplay.textContent = accuracy + '%';

            const minutes = Math.floor(elapsed * 60 / 60);
            const seconds = Math.floor(elapsed * 60 % 60);
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkCompletion() {
            if (input.value === targetText && !completed) {
                completed = true;
                display.style.border = '2px solid #4CAF50';
            }
        }

        function restart() {
            input.value = '';
            completed = false;
            startTime = null;
            display.style.border = 'none';
            display.scrollTop = 0;
            input.focus();
            renderText();
            wpmDisplay.textContent = '0';
            accuracyDisplay.textContent = '100%';
            timeDisplay.textContent = '0:00';
        }

        input.addEventListener('input', () => {
            if (!startTime && input.value.length > 0) {
                startTime = Date.now();
            }
            renderText();
            calculateStats();
            checkCompletion();
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                restart();
            }
        });

        restartBtn.addEventListener('click', restart);

        // Focus hidden input when clicking anywhere on the page
        document.addEventListener('click', () => input.focus());

        // Initial render
        renderText();
        input.focus();
    </script>
</body>
</html>
